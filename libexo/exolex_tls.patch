1c1
< /* A lexical scanner generated by flex*/
---
> /* A lexical scanner generated by flex */
12,13c12
< #include <unistd.h>
< 
---
> #include <errno.h>
25a25,27
> #ifndef _WIN32
> #include <unistd.h>
> #endif
64a67
> 
101,102c104,105
< extern int yyleng;
< extern FILE *yyin, *yyout;
---
> extern __thread int yyleng;
> extern __thread FILE *yyin, *yyout;
137,145d139
< /* Some routines like yy_flex_realloc() are emitted as static but are
<    not called by all lexers. This generates warnings in some compilers,
<    notably GCC. Arrange to suppress these. */
< #ifdef __GNUC__
< #define YY_MAY_BE_UNUSED __attribute__((unused))
< #else
< #define YY_MAY_BE_UNUSED
< #endif
< 
210c204
< static YY_BUFFER_STATE yy_current_buffer = 0;
---
> static __thread YY_BUFFER_STATE yy_current_buffer = 0;
220c214
< static char yy_hold_char;
---
> static __thread char yy_hold_char; // jdonald
222c216
< static int yy_n_chars;		/* number of characters read into yy_ch_buf */
---
> static __thread int yy_n_chars;		/* number of characters read into yy_ch_buf */ // jdonald
225c219
< int yyleng;
---
> __thread int yyleng;
228,230c222,224
< static char *yy_c_buf_p = (char *) 0;
< static int yy_init = 1;		/* whether we need to initialize */
< static int yy_start = 0;	/* start state number */
---
> static __thread char *yy_c_buf_p = (char *) 0;
> static __thread int yy_init = 1;		/* whether we need to initialize */
> static __thread int yy_start = 0;	/* start state number */
235c229
< static int yy_did_buffer_switch_on_eof;
---
> static __thread int yy_did_buffer_switch_on_eof;
252c246
< static void *yy_flex_realloc YY_PROTO(( void *, yy_size_t )) YY_MAY_BE_UNUSED;
---
> static void *yy_flex_realloc YY_PROTO(( void *, yy_size_t ));
274c268
< FILE *yyin = (FILE *) 0, *yyout = (FILE *) 0;
---
> __thread FILE *yyin = (FILE *) 0, *yyout = (FILE *) 0;
276c270
< extern char *yytext;
---
> extern __thread char *yytext;
424,425c418,419
< static yy_state_type yy_last_accepting_state;
< static char *yy_last_accepting_cpos;
---
> static __thread yy_state_type yy_last_accepting_state;
> static __thread char *yy_last_accepting_cpos;
434c428
< char *yytext;
---
> char __thread *yytext;
532c526
< unsigned line = 1;		/* line of last recognized token */
---
> __thread unsigned line = 1;		/* line of last recognized token */
539c533
< #line 540 "lex.yy.c"
---
> #line 534 "lex.yy.c"
574,576c568,570
< static int yy_start_stack_ptr = 0;
< static int yy_start_stack_depth = 0;
< static int *yy_start_stack = 0;
---
> static __thread int yy_start_stack_ptr = 0; // jdonald: also missed these. they depend on YY_STACK_USED?
> static __thread int yy_start_stack_depth = 0;
> static __thread int *yy_start_stack = 0;
639,641c633,646
< 	else if ( ((result = fread( buf, 1, max_size, yyin )) == 0) \
< 		  && ferror( yyin ) ) \
< 		YY_FATAL_ERROR( "input in flex scanner failed" );
---
> 	else \
> 		{ \
> 		errno=0; \
> 		while ( (result = fread(buf, 1, max_size, yyin))==0 && ferror(yyin)) \
> 			{ \
> 			if( errno != EINTR) \
> 				{ \
> 				YY_FATAL_ERROR( "input in flex scanner failed" ); \
> 				break; \
> 				} \
> 			errno=0; \
> 			clearerr(yyin); \
> 			} \
> 		}
687c692
< 	register char *yy_cp = NULL, *yy_bp = NULL;
---
> 	register char *yy_cp, *yy_bp;
693c698
< #line 694 "lex.yy.c"
---
> #line 699 "lex.yy.c"
907c912
< #line 908 "lex.yy.c"
---
> #line 913 "lex.yy.c"
1287d1291
< #ifndef YY_NO_INPUT
1359c1363
< #endif /* YY_NO_INPUT */
---
> 
1469a1474,1482
> #ifndef _WIN32
> #include <unistd.h>
> #else
> #ifndef YY_ALWAYS_INTERACTIVE
> #ifndef YY_NEVER_INTERACTIVE
> extern int isatty YY_PROTO(( int ));
> #endif
> #endif
> #endif
1835c1848
<   static struct {
---
>   static __thread struct { // only three sneaky static vars in exolex /jdonald
1839,1840c1852,1853
<   static int num_streams = 0;
<   static FILE *last_stream = NULL;
---
>   static __thread int num_streams = 0;
>   static __thread FILE *last_stream = NULL;
